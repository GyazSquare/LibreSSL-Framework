packagedir=$(LIBRESSL_PACKAGE_DIR)
builddir=$(packagedir)
installdir=$(LIBRESSL_INSTALL_DIR)
libdir=$(LIBRESSL_LIB_DIR)
includedir=$(LIBRESSL_INCLUDE_DIR)
libname=libressl.$(LIBRESSL_PACKAGE_VERSION).dylib
openssldir=$(TMPDIR)/libressl.$(LIBRESSL_PACKAGE_VERSION)

ifeq ($(ONLY_ACTIVE_ARCH),YES)
TARGET_ARCHS="$(arch)"
else
TARGET_ARCHS="$(ARCHS)"
endif
CFLAGS=$(shell echo "$(TARGET_ARCHS)" | sed 's/ / -arch /g' | sed 's/^/-arch /g')
LDFLAGS=$(CFLAGS)

CONFIGURE=$(packagedir)/configure
CONFIGUREFLAGS=--prefix="$(installdir)" --libdir="$(libdir)" --includedir="$(includedir)" --disable-shared --disable-asm --with-openssldir="$(openssldir)"

all: clean "$(libname)"

install: distclean "$(libname)"

"$(libname)": "$(installdir)"
	cd "$(builddir)" && \
CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)" $(CONFIGURE) $(CONFIGUREFLAGS) && \
make check && \
make install

"$(installdir)":
	mkdir -p "$(installdir)"

clean:
	-rm -fr - "$(installdir)" && \
cd "$(builddir)" && make clean || true

distclean:
	-rm -fr - "$(installdir)" && \
cd "$(builddir)" && make distclean || true
